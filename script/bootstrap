#!/usr/bin/env bash
set -e

# Get the root dotfiles folder
DFSCRIPTSDIR=$(dirname $0)
cd $DFSCRIPTSDIR/..
DOTFILESDIR=$(pwd -P)

# Include core
source script/core

# Run some core prerequisite installs
source script/command-line-tools # For OS X
source script/apt-prerequisites # For Linux

# Run prereq scripts
for PREREQ_SCRIPT in $DOTFILESDIR/**/prerequisites.sh; do

    # Skip files in script/
    PREREQ_SCRIPT_NAME=${PREREQ_SCRIPT#$DOTFILESDIR/}
    echo $PREREQ_SCRIPT_NAME | egrep -q '^script/' && continue

    # Run the script
    source $PREREQ_SCRIPT

done

# Get OMZ and install it to oh-my-zsh-core
OMZ_ROOT=$DOTFILESDIR/oh-my-zsh-core
source script/download-omz

# Download private dotfiles repos, useful for repos that contain sensitive data
source script/download-private-repos

# Run bootstrap scripts in all topic folders
for BOOTSTRAP_SCRIPT in $DOTFILESDIR/**/bootstrap.sh; do

    # If there are no files then bail
    [[ -f $BOOTSTRAP_SCRIPT ]] && break

    # Skip files in script/
    BOOTSTRAP_SCRIPT_NAME=${BOOTSTRAP_SCRIPT#$DOTFILESDIR/}
    echo $BOOTSTRAP_SCRIPT_NAME | egrep -p '^script/' && continue

    # Check if this section is being skipped via an env varaible
    is_valid_topic $BOOTSTRAP_SCRIPT_NAME bootstrap.sh && continue 

    # Run the script
    source $BOOTSTRAP_SCRIPT

done

# Move over to our install script
source script/install